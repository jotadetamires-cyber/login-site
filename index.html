<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Controle de Dívidas</title>
  <style>
    :root{--green:#2e9b3a;--blue:#0080ff;--card:#fff;--bg:#f3f6f8}
    html,body{height:100%;margin:0;font-family:Inter, Arial, Helvetica, sans-serif;background:var(--bg);color:#222}
    .container{max-width:960px;margin:28px auto;padding:20px}
    h1{text-align:center;font-size:34px;margin-bottom:18px}

    .card{background:var(--card);border-radius:8px;padding:18px;box-shadow:0 6px 18px rgba(20,30,40,0.06)}
    .form-row{display:flex;gap:12px;margin-bottom:10px}
    .form-row .col{flex:1}
    label{display:block;font-size:13px;margin-bottom:6px;color:#444}
    input[type=text], input[type=number], input[type=date], select{width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;box-sizing:border-box}
    .btn{display:inline-block;padding:10px 14px;border-radius:6px;border:none;cursor:pointer}
    .btn-green{background:var(--green);color:#fff}
    .btn-secondary{background:#2b8cff;color:#fff}
    .controls{display:flex;gap:8px;align-items:center;margin-top:12px}

    table{width:100%;border-collapse:collapse;margin-top:18px}
    th,td{padding:10px;border:1px solid #e6eef8;text-align:left;font-size:14px}
    thead th{background:var(--blue);color:#fff}

    .actions{display:flex;gap:8px}
    .small{font-size:13px;padding:8px 10px}

    @media(max-width:720px){.form-row{flex-direction:column}}
  </style>
</head>
<body>
  <div class="container">
    <h1>Controlo de Dívidas</h1>

    <div class="card">
      <div class="form-row">
        <div class="col">
          <label for="nome">Nome do Beneficiário</label>
          <input id="nome" type="text" placeholder="Nome do Beneficiário" />
        </div>
        <div class="col">
          <label for="fornecedor">Fornecedor</label>
          <input id="fornecedor" type="text" placeholder="Fornecedor" />
        </div>
      </div>

      <div class="form-row">
        <div class="col">
          <label for="material">Material</label>
          <input id="material" type="text" placeholder="Material" />
        </div>
        <div class="col">
          <label for="quantidade">Quantidade</label>
          <input id="quantidade" type="number" min="0" step="1" placeholder="Quantidade" />
        </div>
      </div>

      <div class="form-row">
        <div class="col">
          <label for="preco">Preço Unitário</label>
          <input id="preco" type="number" min="0" step="0.01" placeholder="Preço Unitário" />
        </div>
        <div class="col">
          <label for="status">Status</label>
          <select id="status">
            <option value="">Selecione o Status</option>
            <option value="Pendente">Pendente</option>
            <option value="Pago">Pago</option>
          </select>
        </div>
      </div>

      <div style="display:flex;gap:10px;align-items:center;margin-top:12px">
        <button class="btn btn-green" id="btnAdicionar">Adicionar Dívida</button>
        <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
          <div style="display:flex;gap:6px;align-items:center">
            <label style="font-size:13px;color:#555">Total:</label>
            <strong id="previewTotal">0.00</strong>
          </div>
        </div>
      </div>
    </div>

    <div style="display:flex;gap:12px;align-items:center;margin-top:16px">
      <input type="date" id="dataInicio" />
      <input type="date" id="dataFim" />
      <select id="filtroStatus">
        <option value="Todos">Todos</option>
        <option value="Pendente">Pendente</option>
        <option value="Pago">Pago</option>
      </select>
      <div class="actions" style="margin-left:auto">
        <button class="btn btn-secondary small" id="btnBuscar">Buscar</button>
        <button class="btn btn-green small" id="btnGerarPDF">Gerar PDF</button>
      </div>
    </div>

    <table id="tabela">
      <thead>
        <tr>
          <th>Data</th>
          <th>Nome</th>
          <th>Fornecedor</th>
          <th>Material</th>
          <th>Quantidade</th>
          <th>Preço Unitário</th>
          <th>Preço Total</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    // Helpers
    function fmtNumber(v){
      if (v === null || v === undefined || v === "") return '';
      return parseFloat(v).toLocaleString('pt-PT', {minimumFractionDigits:2, maximumFractionDigits:2});
    }

    function calcularTotalPreview(){
      const q = parseFloat(document.getElementById('quantidade').value) || 0;
      const p = parseFloat(document.getElementById('preco').value) || 0;
      document.getElementById('previewTotal').innerText = fmtNumber(q * p);
    }

    // Atualiza preview quando mudam quantidade/preço
    document.getElementById('quantidade').addEventListener('input', calcularTotalPreview);
    document.getElementById('preco').addEventListener('input', calcularTotalPreview);

    // Adicionar dívida (chama backend do Google Apps Script)
    document.getElementById('btnAdicionar').addEventListener('click', function(){
      const nome = document.getElementById('nome').value.trim();
      const fornecedor = document.getElementById('fornecedor').value.trim();
      const material = document.getElementById('material').value.trim();
      const quantidade = parseFloat(document.getElementById('quantidade').value) || 0;
      const preco = parseFloat(document.getElementById('preco').value) || 0;
      const status = document.getElementById('status').value;

      if(!nome || !fornecedor || !material || !status){
        alert('Por favor preencha todos os campos obrigatórios (Nome, Fornecedor, Material, Status).');
        return;
      }

      if (typeof google === 'undefined' || !google.script){
        alert('Este HTML deve ser servido via Google Apps Script (https://script.google.com/macros/s/AKfycbxwT6xGXU3dnvGmnL60_S6cQhMWQBB8TBi9X3O_ABDzy1kZBP8lqb9KBGvpj5FXPeTsEQ/exec). A função google.script.run não existe aqui.');
        return;
      }

      document.getElementById('btnAdicionar').disabled = true;
      google.script.run.withSuccessHandler(function(res){
        alert(res || 'Dívida adicionada.');
        document.getElementById('nome').value = '';
        document.getElementById('fornecedor').value = '';
        document.getElementById('material').value = '';
        document.getElementById('quantidade').value = '';
        document.getElementById('preco').value = '';
        document.getElementById('status').value = '';
        calcularTotalPreview();
        document.getElementById('btnAdicionar').disabled = false;
        buscarDividas();
      }).salvarDivida(nome, fornecedor, material, quantidade, preco, status);
    });

    // Buscar dívidas com filtros
    document.getElementById('btnBuscar').addEventListener('click', buscarDividas);

    function buscarDividas(){
      const inicio = document.getElementById('dataInicio').value;
      const fim = document.getElementById('dataFim').value;
      const status = document.getElementById('filtroStatus').value || 'Todos';

      if (typeof google === 'undefined' || !google.script){
        console.warn('google.script.run não disponível (teste local).');
        return;
      }

      google.script.run.withSuccessHandler(preencherTabela).buscarDividas(inicio, fim, status);
    }

    function preencherTabela(dados){
      const tbody = document.querySelector('#tabela tbody');
      tbody.innerHTML = '';
      if (!dados || !dados.length) return;

      dados.forEach(function(linha){
        const tr = document.createElement('tr');
        const cells = [linha[0], linha[1], linha[2], linha[3], linha[4], linha[5], linha[6], linha[7]];
        cells.forEach(function(c, i){
          const td = document.createElement('td');
          if (i === 0){
            let d = c;
            if (typeof c === 'object' && c !== null && c.toISOString) d = new Date(c).toLocaleString();
            td.innerText = d || '';
          } else if (i === 4 || i === 5 || i === 6){
            td.innerText = (c === '' || c === null) ? '' : fmtNumber(c);
          } else {
            td.innerText = c || '';
          }
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
    }

    // Gerar PDF
    document.getElementById('btnGerarPDF').addEventListener('click', function(){
      const inicio = document.getElementById('dataInicio').value;
      const fim = document.getElementById('dataFim').value;
      const status = document.getElementById('filtroStatus').value || 'Todos';

      if (typeof google === 'undefined' || !google.script){
        alert('Esta função só funciona quando o HTML é servido por Google Apps Script');
        return;
      }

      document.getElementById('btnGerarPDF').disabled = true;
      google.script.run.withSuccessHandler(function(url){
        document.getElementById('btnGerarPDF').disabled = false;
        if (url) window.open(url, '_blank');
        else alert('Não foram encontrados dados para o filtro selecionado.');
      }).gerarRelatorioPDF(inicio, fim, status);
    });

    if (typeof google !== 'undefined' && google.script){
      buscarDividas();
    }
  </script>

  <!-- Backend Apps Script -->
  <script type="text/plain" id="apps-script-backend">
    function salvarDivida(nome, fornecedor, material, quantidade, preco, status) {
      var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Base de Dados");
      var data = new Date();
      var precoTotal = quantidade * preco;
      sheet.appendRow([data, nome, fornecedor, material, quantidade, preco, precoTotal, status]);
      return "Dívida adicionada com sucesso!";
    }

    function buscarDividas(dataInicio, dataFim, status) {
      var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Base de Dados");
      var dados = sheet.getDataRange().getValues();
      var resultado = [];
      for (var i = 1; i < dados.length; i++) {
        var linha = dados[i];
        var data = new Date(linha[0]);
        if ((status === "Todos" || status === linha[7]) &&
            (!dataInicio || data >= new Date(dataInicio)) &&
            (!dataFim || data <= new Date(dataFim))) {
          resultado.push(linha);
        }
      }
      return resultado;
    }

    function gerarRelatorioPDF(dataInicio, dataFim, status) {
      var dados = buscarDividas(dataInicio, dataFim, status);
      var doc = DocumentApp.create("Relatório de Dívidas");
      var body = doc.getBody();
      body.appendParagraph("Relatório de Dívidas");
      body.appendParagraph("Período: " + dataInicio + " até " + dataFim + " | Status: " + status);
      var tabela = [];
      tabela.push(["Data","Nome","Fornecedor","Material","Quantidade","Preço Unitário","Preço Total","Status"]);
      for (var i=0;i<dados.length;i++){tabela.push(dados[i]);}
      body.appendTable(tabela);
      var pdf = DriveApp.getFileById(doc.getId()).getAs("application/pdf");
      var url = DriveApp.createFile(pdf).getUrl();
      DriveApp.getFileById(doc.getId()).setTrashed(true);
      return url;
    }
  </script>
</body>
</html>
