<script>
function atualizarCorStatus(select){
    if(select.value === "Pago"){ select.style.color = "green"; }
    else if(select.value === "Não Pago"){ select.style.color = "red"; }
    else { select.style.color = "black"; }
}

function criarCelulaEditavel(text, tipo="text"){
    const input = document.createElement("input");
    input.value = text; input.type = tipo;
    input.style.textAlign = "center"; input.style.width = "95%";
    return input;
}

function gerarRelatorio(){
    const linhas = document.querySelectorAll("#tabelaServicos tbody tr");
    const hoje = new Date();
    const hojeTexto = hoje.toLocaleDateString('pt-BR');
    const mesAtual = hoje.getMonth();
    const anoAtual = hoje.getFullYear();
    const tipo = document.getElementById("tipoRelatorio").value;

    let totalRegistros = 0, totalPago = 0, totalNaoPago = 0;
    let somaPago = 0, somaNaoPago = 0;
    let listaPago = [], listaNaoPago = [];

    linhas.forEach(linha=>{
        const dataStr = linha.cells[3].innerText;
        const partes = dataStr.split("/");
        const data = new Date(partes[2], partes[1]-1, partes[0]);
        const preco = parseFloat(linha.cells[2].querySelector('input').value) || 0;
        const status = linha.cells[4].querySelector('select').value;
        const servico = linha.cells[0].querySelector('input').value;
        const assinatura = linha.cells[1].querySelector('input').value;

        const eHoje = dataStr === hojeTexto;
        const eMesAtual = data.getMonth() === mesAtual && data.getFullYear() === anoAtual;

        if((tipo==="diario" && eHoje) || (tipo==="mensal" && eMesAtual)){
            totalRegistros++;
            if(status==="Pago"){
                totalPago++; somaPago += preco;
                listaPago.push(`• ${servico} (${assinatura}) no valor de ${preco.toFixed(2)} MT`);
            } else if(status==="Não Pago"){
                totalNaoPago++; somaNaoPago += preco;
                listaNaoPago.push(`• ${servico} (${assinatura}) no valor de ${preco.toFixed(2)} MT`);
            }
        }
    });

    const titulo = tipo==="diario" ? 
        `Relatório Detalhado de ${hojeTexto}` :
        `Relatório Mensal (${hoje.toLocaleString('pt-BR',{month:'long'})} / ${anoAtual})`;

    // --- Texto mais descritivo ---
    let texto = `<b>${titulo}</b><br><br>`;
    texto += `No dia a <b>Papelaria Muipeliua</b> atendeu um total de <b>${totalRegistros}</b> serviços. `;

    if(totalPago > 0){
        texto += `Foram <span style="color:green"><b>${totalPago}</b> serviços pagos</span>, 
        gerando uma receita total de <b>${somaPago.toFixed(2)} MT</b>, conforme a lista:<br>`;
        texto += listaPago.join("<br>") + "<br><br>";
    } else {
        texto += `Não houve serviços pagos neste período.<br><br>`;
    }

    if(totalNaoPago > 0){
        texto += `Também foram registados <span style="color:red"><b>${totalNaoPago}</b> serviços não pagos</span>, 
        somando <b>${somaNaoPago.toFixed(2)} MT</b>, descritos a seguir:<br>`;
        texto += listaNaoPago.join("<br>") + "<br>";
    } else {
        texto += `Não houve serviços pendentes de pagamento.<br>`;
    }

    document.getElementById("relatorioResumo").innerHTML = texto;
}

document.getElementById('cadastroForm').addEventListener('submit', function(event){
    event.preventDefault();

    const servico = document.getElementById('servico').value;
    const assinatura = document.getElementById('assinatura').value;
    const preco = parseFloat(document.getElementById('preco').value).toFixed(2);
    const status = document.getElementById('status').value;
    const data = new Date().toLocaleDateString('pt-BR');

    const tabela = document.querySelector('#tabelaServicos tbody');
    const novaLinha = tabela.insertRow();

    novaLinha.insertCell(0).appendChild(criarCelulaEditavel(servico));
    novaLinha.insertCell(1).appendChild(criarCelulaEditavel(assinatura));
    novaLinha.insertCell(2).appendChild(criarCelulaEditavel(preco, "number"));
    novaLinha.insertCell(3).innerText = data;

    const statusCell = novaLinha.insertCell(4);
    const selectStatus = document.createElement('select');
    selectStatus.className = 'statusSelect';
    ['Pago','Não Pago'].forEach(op=>{
        const option = document.createElement('option');
        option.value = op; option.text = op;
        if(op===status) option.selected = true;
        selectStatus.appendChild(option);
    });
    atualizarCorStatus(selectStatus);
    statusCell.appendChild(selectStatus);

    const acaoCell = novaLinha.insertCell(5);
    const botaoExcluir = document.createElement('button');
    botaoExcluir.innerText = "Eliminar"; botaoExcluir.className = "deleteBtn";
    botaoExcluir.disabled = selectStatus.value !== "Pago";
    botaoExcluir.addEventListener('click', ()=>{
        novaLinha.remove(); gerarRelatorio();
    });
    acaoCell.appendChild(botaoExcluir);

    function atualizarTudo(){
        atualizarCorStatus(selectStatus);
        botaoExcluir.disabled = selectStatus.value !== "Pago";
        gerarRelatorio();
    }
    [selectStatus,
     novaLinha.cells[2].querySelector('input'),
     novaLinha.cells[1].querySelector('input'),
     novaLinha.cells[0].querySelector('input')
    ].forEach(el=>el.addEventListener('input', atualizarTudo));
    selectStatus.addEventListener('change', atualizarTudo);

    document.getElementById('cadastroForm').reset();
    gerarRelatorio();
});

// muda tipo de relatório
document.getElementById("tipoRelatorio").addEventListener("change", gerarRelatorio);

// PDF
document.getElementById("btnPDF").addEventListener("click", ()=>{
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const hoje = new Date().toLocaleDateString('pt-BR');
    const tipo = document.getElementById("tipoRelatorio").value;
    const titulo = tipo==="diario" ? "Relatório Diário" : "Relatório Mensal";

    doc.setFont("times", "bold");
    doc.setFontSize(14);
    doc.text("REPÚBLICA DE MOÇAMBIQUE", 105, 20, null, null, "center");
    doc.text("Papelaria Muipeliua", 105, 28, null, null, "center");
    doc.text(`${titulo} - ${hoje}`, 105, 36, null, null, "center");
    doc.line(20, 40, 190, 40);

    const textoRelatorio = document.getElementById("relatorioResumo").innerText;
    doc.setFont("times", "normal");
    doc.setFontSize(12);
    doc.text(textoRelatorio, 20, 50, { maxWidth: 170, align: "justify" });

    doc.save(`Relatorio_${tipo}_${hoje}.pdf`);
});

// inicializa
window.addEventListener('load', gerarRelatorio);
</script>
