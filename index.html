<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cadastro de Serviços - Relatório Detalhado</title>
<style>
    /* Layout da aplicação */
    body {
        font-family: Arial, sans-serif;
        margin: 20px;
        background-color: #f4f4f4;
        display: flex;
        justify-content: center;
    }
    .container {
        background-color: #fff;
        padding: 18px;
        border-radius: 8px;
        box-shadow: 0 0 10px rgba(0,0,0,0.1);
        width: 780px;
    }
    h1, h2 { text-align: center; color: #333; margin: 6px 0; }
    form {
        margin-bottom: 14px;
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px 12px;
    }
    form div { display: flex; flex-direction: column; }
    label { margin-bottom: 3px; font-weight: bold; font-size: 13px; }
    input, select {
        width: 100%; padding: 6px; border: 1px solid #ccc;
        border-radius: 4px; text-align: center; font-size: 14px;
    }
    .full-width { grid-column: 1 / 3; }
    button {
        background-color: #28a745; color: white; padding: 8px 12px;
        border: none; border-radius: 4px; cursor: pointer;
        font-size: 14px; grid-column: 1 / 3; justify-self: center;
    }
    button:hover { background-color: #218838; }

    table {
        width: 100%; border-collapse: collapse;
        margin-top: 10px; text-align: left; font-size: 13px;
    }
    th, td { border: 1px solid #ddd; padding: 6px; }
    th { background-color: #f2f2f2; }
    tbody tr:nth-child(odd) { background-color: #f9f9f9; }
    select.statusSelect {
        width: 100%; border: none; background-color: transparent;
        text-align: center; font-weight: bold;
    }
    button.deleteBtn {
        background-color: #dc3545; color: white; padding: 4px 8px;
        border-radius: 4px; border: none; cursor: pointer; font-size: 13px;
    }
    button.deleteBtn:hover { background-color: #c82333; }

    /* Relatório - estilo institucional (Times New Roman) */
    .relatorioBox { margin-top: 18px; padding: 10px; }
    .relatorioConteudo {
        font-family: "Times New Roman", Times, serif;
        font-size: 14px;
        line-height: 1.5;
        color: #000;
        background: #fff;
        padding: 18px;
        border-radius: 6px;
    }
    .relatorioCabecalho { text-align: center; margin-bottom: 12px; }
    .emblema {
        width: 90px; height: 90px; display: block; margin: 0 auto 6px;
    }
    .tituloCabecalho { font-weight: bold; margin: 2px 0; }
    .acoesRelatorio { display:flex; gap:10px; justify-content:center; margin-top:10px; }

    /* Estilos de impressão (vai garantir Times New Roman e layout adequado) */
    @media print {
        body { background: #fff; }
        .container { box-shadow: none; width: auto; margin: 0; padding: 0; }
        .no-print { display: none !important; }
        .relatorioConteudo { box-shadow: none; }
    }
</style>
</head>
<body>

<div class="container">
    <h1>Cadastro de Serviços</h1>

    <form id="cadastroForm" class="no-print">
        <div><label>Tipo de Serviço:</label><input type="text" id="servico" required></div>
        <div><label>Assinatura:</label><input type="text" id="assinatura" required></div>
        <div><label>Preço (MZN):</label><input type="number" id="preco" step="0.01" required></div>
        <div><label>Status:</label>
            <select id="status" required>
                <option value="">Selecione</option>
                <option value="Pago">Pago</option>
                <option value="Não Pago">Não Pago</option>
            </select>
        </div>
        <button type="submit">Cadastrar</button>
    </form>

    <h2 class="no-print">Registros Cadastrados</h2>
    <table id="tabelaServicos" class="no-print">
        <thead>
            <tr>
                <th>Serviço</th><th>Assinatura</th>
                <th>Preço (MZN)</th><th>Data</th><th>Status</th><th>Ações</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <div class="relatorioBox">
        <div id="relatorioDiario" class="relatorioConteudo" aria-live="polite">
            <!-- Relatório detalhado institucional será gerado aqui automaticamente -->
        </div>

        <div class="acoesRelatorio no-print">
            <button id="baixarPdfBtn">Baixar/Imprimir Relatório (PDF)</button>
        </div>
    </div>
</div>

<script>
/* ---------------- utilidades ---------------- */
function formatarMZN(valor){
    // Formata em Metical (MZN) com separador pt-BR. Fallback simples se Intl não suportar MZN.
    try{
        return new Intl.NumberFormat('pt-MZ', { style: 'currency', currency: 'MZN' }).format(valor);
    }catch(e){
        return 'MT ' + Number(valor).toFixed(2).replace('.', ',');
    }
}

function criarInputEditavel(valor, tipo="text"){
    const input = document.createElement('input');
    input.value = valor;
    input.type = tipo;
    input.style.textAlign = "center";
    input.style.width = "95%";
    return input;
}

function atualizarCorStatus(select){
    if(select.value === "Pago"){ select.style.color = "green"; }
    else if(select.value === "Não Pago"){ select.style.color = "red"; }
    else { select.style.color = "black"; }
}

/* ---------------- lógica de cadastro ---------------- */
document.getElementById('cadastroForm').addEventListener('submit', function(e){
    e.preventDefault();

    const servico = document.getElementById('servico').value.trim();
    const assinatura = document.getElementById('assinatura').value.trim();
    const precoRaw = parseFloat(document.getElementById('preco').value);
    const preco = Number.isNaN(precoRaw) ? 0 : precoRaw;
    const status = document.getElementById('status').value;
    const data = new Date().toLocaleDateString('pt-BR');

    const tbody = document.querySelector('#tabelaServicos tbody');
    const tr = tbody.insertRow();

    tr.insertCell(0).appendChild(criarInputEditavel(servico, "text"));
    tr.insertCell(1).appendChild(criarInputEditavel(assinatura, "text"));
    tr.insertCell(2).appendChild(criarInputEditavel(preco.toFixed(2), "number"));
    tr.insertCell(3).innerText = data;

    // Status
    const statusCell = tr.insertCell(4);
    const select = document.createElement('select');
    select.className = 'statusSelect';
    ['Pago','Não Pago'].forEach(op=>{
        const opt = document.createElement('option');
        opt.value = op; opt.text = op;
        if(op === status) opt.selected = true;
        select.appendChild(opt);
    });
    atualizarCorStatus(select);
    statusCell.appendChild(select);

    // Ações
    const acaoCell = tr.insertCell(5);
    const btnExcluir = document.createElement('button');
    btnExcluir.className = 'deleteBtn';
    btnExcluir.innerText = 'Eliminar';
    btnExcluir.disabled = select.value !== 'Pago';
    btnExcluir.addEventListener('click', ()=> { tr.remove(); gerarRelatorio(); });
    acaoCell.appendChild(btnExcluir);

    // Atualizações quando editar
    function atualizarTudo(){
        atualizarCorStatus(select);
        btnExcluir.disabled = select.value !== 'Pago';
        gerarRelatorio();
    }
    [tr.cells[0].querySelector('input'), tr.cells[1].querySelector('input'), tr.cells[2].querySelector('input'), select].forEach(el=>{
        el.addEventListener('input', atualizarTudo);
        el.addEventListener('change', atualizarTudo);
    });

    // limpar form e atualizar relatório
    document.getElementById('cadastroForm').reset();
    gerarRelatorio();
});

/* ---------------- construção do relatório institucional detalhado ---------------- */
function gerarRelatorio(){
    const hoje = new Date();
    const dataHojeStr = hoje.toLocaleDateString('pt-BR');

    // coletar linhas do dia
    const linhas = Array.from(document.querySelectorAll('#tabelaServicos tbody tr'));
    const registrosDoDia = linhas.filter(l => l.cells[3].innerText === dataHojeStr);

    // agrupar por tipo de serviço
    const agrupado = {}; // { servico: { pagos: [...], naoPagos: [...] } }
    registrosDoDia.forEach(l => {
        const servico = l.cells[0].querySelector('input').value.trim() || "(Sem descrição)";
        const assinatura = l.cells[1].querySelector('input').value.trim();
        const preco = parseFloat(l.cells[2].querySelector('input').value) || 0;
        const status = l.cells[4].querySelector('select').value;

        if(!agrupado[servico]) agrupado[servico] = { pagos: [], naoPagos: [] };
        const registro = { assinatura, preco, status };
        if(status === 'Pago') agrupado[servico].pagos.push(registro);
        else agrupado[servico].naoPagos.push(registro);
    });

    // totais do dia
    let totalRegistros = 0, totalPagoCount = 0, totalNaoPagoCount = 0;
    let totalPagoValor = 0, totalNaoPagoValor = 0;
    for(const serv in agrupado){
        const g = agrupado[serv];
        totalPagoCount += g.pagos.length;
        totalNaoPagoCount += g.naoPagos.length;
        g.pagos.forEach(r => totalPagoValor += r.preco);
        g.naoPagos.forEach(r => totalNaoPagoValor += r.preco);
        totalRegistros += g.pagos.length + g.naoPagos.length;
    }

    // montar HTML do relatório institucional (corrida, descritiva)
    let html = '';

    // Cabeçalho institucional (emblema inline SVG — substitua se quiser por <img src="seu-emblema.png">)
    html += `<div class="relatorioCabecalho">`;
    html += `<svg class="emblema" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                <rect width="100" height="100" rx="12" ry="12" fill="#e6e6e6"></rect>
                <text x="50" y="55" font-size="12" text-anchor="middle" fill="#333" font-family="Times New Roman">EMBLEMA</text>
             </svg>`;
    html += `<div class="tituloCabecalho">REPÚBLICA DE MOÇAMBIQUE</div>`;
    html += `<div class="tituloCabecalho">PAPELARIA MUIPELIUA</div>`;
    html += `<div class="tituloCabecalho">RELATÓRIO DIÁRIO - ${dataHojeStr}</div>`;
    html += `</div>`;

    // Introdução do relatório (parágrafo corrido)
    html += `<div>`;
    html += `<p>Em atendimento às actividades administrativas e de abastecimento realizadas no dia <strong>${dataHojeStr}</strong>, este relatório descreve de forma detalhada os serviços registrados, discriminando os que se encontram com o estado "Pago" e os que ainda se encontram "Não Pago". A informação abaixo apresenta, por tipo de serviço, a descrição das assinaturas relacionadas e os valores respectivos, seguidos das somas totais do dia.</p>`;

    if(totalRegistros === 0){
        html += `<p>Não foram registados serviços na data mencionada.</p>`;
    } else {
        // Para cada tipo de serviço, parágrafos separados
        for(const serv in agrupado){
            const g = agrupado[serv];
            html += `<h3 style="text-align:left; margin-top:10px;">Serviço: ${serv}</h3>`;

            // pagos
            if(g.pagos.length){
                html += `<p><strong>Serviços PAGOS (detalhes):</strong></p>`;
                g.pagos.forEach((r, i) => {
                    html += `<p>• Assinatura: ${r.assinatura || '-'} — Valor pago: ${formatarMZN(r.preco)}</p>`;
                });
                const somaPagos = g.pagos.reduce((s, it) => s + it.preco, 0);
                html += `<p>Total recebido para este serviço: <strong>${formatarMZN(somaPagos)}</strong></p>`;
            } else {
                html += `<p><strong>Serviços PAGOS (detalhes):</strong> Nenhum registro pago para este serviço.</p>`;
            }

            // não pagos
            if(g.naoPagos.length){
                html += `<p><strong>Serviços NÃO PAGOS (detalhes):</strong></p>`;
                g.naoPagos.forEach((r, i) => {
                    html += `<p>• Assinatura: ${r.assinatura || '-'} — Valor em dívida: ${formatarMZN(r.preco)}</p>`;
                });
                const somaNaoPagos = g.naoPagos.reduce((s, it) => s + it.preco, 0);
                html += `<p>Valor total em dívida para este serviço: <strong>${formatarMZN(somaNaoPagos)}</strong></p>`;
            } else {
                html += `<p><strong>Serviços NÃO PAGOS (detalhes):</strong> Nenhum registro pendente para este serviço.</p>`;
            }
        }

        // resumo final do dia
        html += `<hr>`;
        html += `<p><strong>Resumo do dia (${dataHojeStr}):</strong></p>`;
        html += `<p>Total de registos: ${totalRegistros}</p>`;
        html += `<p>Total de serviços pagos: ${totalPagoCount} — Valor total recebido: <strong>${formatarMZN(totalPagoValor)}</strong></p>`;
        html += `<p>Total de serviços não pagos: ${totalNaoPagoCount} — Valor total em dívida: <strong>${formatarMZN(totalNaoPagoValor)}</strong></p>`;
        html += `<p><strong>Total geral (recebido + em dívida): ${formatarMZN(totalPagoValor + totalNaoPagoValor)}</strong></p>`;
    }

    // assinatura / rodapé
    html += `<div style="margin-top:18px;">`;
    html += `<p>Elaborado por: <em>Papelaria Muipeliua</em><br>Data de emissão: ${dataHojeStr}</p>`;
    html += `</div>`;

    html += `</div>`; // fecha container de texto

    document.getElementById('relatorioDiario').innerHTML = html;
}

/* gerar relatório ao carregar a página (caso existam entradas com data de hoje) */
gerarRelatorio();

/* botão para baixar/imprimir relatório em PDF via janela de impressão */
document.getElementById('baixarPdfBtn').addEventListener('click', function(){
    // abrir nova janela com conteúdo do relatório (estilos minimalistas) e chamar print
    const conteudo = document.getElementById('relatorioDiario').innerHTML;
    const win = window.open('', '_blank', 'width=900,height=800');
    const estilos = `
        <style>
        body{font-family:"Times New Roman", Times, serif; font-size:14px; line-height:1.5; margin:20px; color:#000}
        .relatorioCabecalho{text-align:center}
        .emblema{display:block;margin:0 auto 6px;width:90px;height:90px}
        h3{margin-top:14px}
        </style>
    `;
    win.document.write(`<!doctype html><html><head><meta charset="utf-8"><title>Relatório Diário</title>${estilos}</head><body>${conteudo}</body></html>`);
    win.document.close();
    // garantir que a janela carregue antes de chamar print
    win.focus();
    setTimeout(()=>{ win.print(); /* o usuário poderá escolher "Salvar como PDF" */ }, 300);
});

/* atualizar relatório sempre que tabela for alterada (delegation) */
const observerTarget = document.querySelector('#tabelaServicos tbody');
const mo = new MutationObserver(gerarRelatorio);
mo.observe(observerTarget, { childList: true, subtree: true, attributes: true, characterData: true });

</script>
</body>
</html>
